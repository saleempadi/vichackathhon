# Arena Concession Optimizer — Victoria Royals

## Project Overview
Data-driven dashboard + fan-facing mobile tool for concession operations at Save-On-Foods Memorial Centre (Victoria Royals, WHL). Built for VTN26 hackathon.

## Tech Stack
- **Framework**: Next.js 16 (App Router), React 19, TypeScript
- **Styling**: Tailwind CSS v4 + shadcn/ui
- **Charts**: Recharts
- **Database**: SQLite via better-sqlite3 (read-only in app, `data/arena.db`)
- **AI**: Claude API (@anthropic-ai/sdk) for natural language insights
- **Data**: 14 CSV files (239K transactions), GameDetails.xlsx (67 games), 6 concession locations

## Project Structure
```
src/
  app/
    page.tsx                    # Overview dashboard (KPIs, charts, top items)
    locations/page.tsx          # Location deep dive (heatmap, category breakdown)
    gameday/page.tsx            # Game day analysis (attendance, opponents, periods)
    predictions/page.tsx        # Predictions + staffing + arena map + QR code
    insights/page.tsx           # AI natural language query page
    fan/layout.tsx              # Mobile-only layout (no sidebar)
    fan/page.tsx                # Fan-facing "Where Should I Go?" page
    api/
      query/route.ts            # Generic query endpoint (dispatches to queries.ts)
      ai-insights/route.ts      # Claude API: question → SQL → answer
      fan/route.ts              # Fan-facing API: wait times, recommendations
  lib/
    db.ts                       # SQLite connection singleton
    queries.ts                  # All pre-built SQL queries
    queueing.ts                 # M/M/c queueing theory model
    hooks.ts                    # useQuery client-side data fetching hook
    utils.ts                    # shadcn/ui cn() helper
  components/
    arena-map.tsx               # SVG arena map with traffic indicators
    charts/bar-chart.tsx        # Reusable Recharts bar chart
    charts/line-chart.tsx       # Reusable Recharts line chart
    charts/scatter-chart.tsx    # Reusable Recharts scatter chart
    charts/heatmap.tsx          # Custom CSS grid heatmap
    layout/sidebar.tsx          # Sidebar navigation
    layout/layout-shell.tsx     # Conditional layout (hides sidebar on /fan)
    ui/                         # shadcn/ui components (card, badge, button, etc.)
scripts/
  seed-db.ts                    # ETL: CSV/XLSX → SQLite
data/
  arena.db                      # SQLite database (generated by seed script)
tests/
  e2e/
    smoke.spec.ts               # Playwright smoke tests for all routes
playwright.config.ts            # Playwright configuration
```

## Key Conventions
- All database queries go in `src/lib/queries.ts` — follow the existing pattern of getDb() + prepared statements
- API routes use `/api/query?q=<queryName>` dispatch pattern — add new query names to the switch in route.ts
- Client pages use `useQuery<T>(queryName, params)` hook from `src/lib/hooks.ts`
- Location names in DB have no "SOFMC " prefix (cleaned during ETL): Island Canteen, Island Slice, Phillips Bar, Portable Stations, ReMax Fan Deck, TacoTacoTaco
- Charts use Recharts wrapper components in `src/components/charts/`
- Pages are 'use client' with data fetching via the useQuery hook

## Data Notes
- Refunds = negative qty values (is_refund=1) — included in data, excluded from most aggregations
- Test data (Category=None, Item=TTT TEST) — excluded during ETL
- Transaction grouping: same date+time+location = one order
- Seasons: 2024-25 and 2025-26
- Categories: Beer, Food, Food - Walking Taco, NA Bev, NA Bev PST Exempt, Snacks, Snack, Sweets, Wine Cider & Coolers, Liquor, Extras

## Running
```bash
# Seed database (only needed once)
npx ts-node --compiler-options '{"module":"commonjs","esModuleInterop":true}' scripts/seed-db.ts

# Start dev server
npm run dev
```

## Testing
```bash
# Run Playwright smoke tests (auto-starts dev server if not running)
npm run test:smoke

# Run with visible browser
npm run test:smoke:headed
```

Smoke tests (`tests/e2e/smoke.spec.ts`) verify all 6 routes load without errors:
- `/, /locations, /gameday, /predictions, /insights, /fan`
- Checks: HTTP status < 400, no JS console errors, no uncaught exceptions, no Next.js error overlay, page has content

## Pre-Push Git Hook
A git pre-push hook (`.git/hooks/pre-push`) runs automatically on every `git push`:
1. `npm run build` — blocks push on type/build errors
2. `npx playwright test` — blocks push if any route crashes

If the hook is lost (e.g., fresh clone), recreate it:
```bash
cat > .git/hooks/pre-push << 'EOF'
#!/bin/sh
cd arena-concession-optimizer || exit 1
echo "Pre-push: running build..."
npm run build || exit 1
echo "Pre-push: running smoke tests..."
npx playwright test || exit 1
echo "All checks passed!"
EOF
chmod +x .git/hooks/pre-push
```

## Fan-Facing Feature ("Where Should I Go?")
Mobile-first page at `/fan` where fans scan a QR code to find the shortest concession line.

- **Queueing model**: M/M/c queueing theory in `src/lib/queueing.ts` — converts historical transaction rates into wait time estimates
- **API**: `GET /api/fan?opponent=...&dayOfWeek=...&gameTime=...&category=...` — returns wait times, top items, recommendations per location
- **Demo URLs**: `/fan?opponent=Portland&dayOfWeek=Friday&gameTime=19:05&period=1st%20Intermission`
- **QR code**: Generated on `/predictions` page, links to `/fan` with game params

## Environment Variables
- `CLAUDE_AUTH_TOKEN` — required for AI Insights page (set in .env.local)
